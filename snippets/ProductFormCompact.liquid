{%- assign product_price = product.selected_or_first_available_variant.price -%}
{%- assign product_compare_price = product.selected_or_first_available_variant.compare_at_price -%}

{%- comment %}
  SET BUTTON TEXT TO PRE-ORDER OR ADD TO CART
{%- endcomment %}
{%- assign button_text = 'Add To Cart' -%}
{%- for tag in product.tags -%}
  {%- assign TAG = tag | upcase -%}
  {%- if TAG == 'PREORDER' -%}
    {%- assign button_text = 'Pre-Order' -%}
  {%- endif -%}
{%- endfor -%}

{%- assign is_percent_off = false -%}
{%- assign is_bogo = false -%}
{%- assign discount_multiplier = 1 -%}
{%- for tag in product.tags -%}
  {%- assign TAG = tag | upcase -%}
  {%- if TAG contains 'PERCENTOFF' -%}
    {%- assign is_percent_off = true -%}
    {%- assign discount_multiplier = TAG | remove: 'PERCENTOFF' -%}
    {%- assign discount_multiplier = discount_multiplier | times: 0.01 -%}
    {%- assign discount_multiplier = 1 | minus: discount_multiplier -%}
  {%- endif -%}
  {%- if TAG == 'BOGO' -%}
    {%- assign is_bogo = true -%}
  {%- endif -%}
{%- endfor -%}

{%- if is_percent_off -%}
  {%- assign product_compare_price = product_price -%}
  {%- assign product_price = product_price | times: discount_multiplier -%}
{%- endif -%}

<form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form"
data-id="{{ product.selected_or_first_available_variant.id }}" 
data-price="{{ product_price | money_with_currency | strip_html }}"
data-compare-price="{{ product_compare_price | money_with_currency | strip_html }}"
data-inventory-quantity="{{ product.selected_or_first_available_variant.inventory_quantity }}"
data-image="{{ product.selected_or_first_available_variant.image }}"
data-estimated-ship-date="{{ product.metafields.suave['estimated_ship_date'] }}"
{%if is_bogo %}data-is-bogo="true"{%endif%}
{%if product.available%}data-available="{{product.available}}"{%endif%}
{%if product.variants.size > 1%}data-has-variants="true"{%endif%}>
  <div class="row">
    <div class="col s6 product-price padding-left-none">
      {{ product_price | money }}
    </div>
    {% if is_bogo %}
      <div class="col s6 padding-left-none center">
        <span style="font-weight:bold;font-size:1.5em;background-color:#fab203;display:inline-block;padding:0 5px;">BOGO</span>
      </div>
    {% endif %}
      <div class="col s6 compare-price padding-left-none" {% if is_bogo %}style="display:none;"{%endif%}>
        {% if product_compare_price and product_compare_price != product_price %}
          {{ product_compare_price | money}}
        {% endif %}
      </div>
    <div class="col s12 padding-none star-rating-container">{%include 'ProductStarRating'%}</div>
    <div class="input-field col s8">
      {% unless product.variants.size == 1 %}
      <select class="product-option variant-selector" aria-label="Product Options{% for option in product.options %} - {{option}}{% endfor %}">
        {% for variant in product.variants %}
          {% if variant.image.product_id %}
            {% assign variant_image = variant.image | img_url: 'large' %}
          {% else %}
            {% assign variant_image = 'no-image' %}
          {% endif %}
          {% if variant.available %}
            {%- assign variant_price = variant.price -%}
            {%- assign variant_compare_at_price = variant.compare_at_price -%}
            {%- if is_percent_off -%}
              {%- assign variant_compare_at_price = variant_price -%}
              {%- assign variant_price = variant_price | times: discount_multiplier -%}
            {%- endif -%}
            <option value="{{ variant.id }}"
            data-id="{{ variant.id }}" 
            data-price="{{ variant_price | money_with_currency | strip_html }}"
            data-compare-price="{{ variant_compare_at_price | money_with_currency | strip_html }}"
            data-inventory-quantity="{{ variant.inventory_quantity }}"
            data-image="{{ variant_image }}"
            data-estimated-ship-date="{{ product.metafields.suave['estimated_ship_date'] }}">
              {{ variant.title }}
            </option>
          {% else %}
            <option disabled="disabled">
              {{ variant.title }} - sold out
            </option>
          {% endif %}
        {% endfor %}
        {% comment %}
            used for back in stock notifications
        {% endcomment %}
        {% for variant in product.variants %}
          {% if variant.image.product_id %}
            {% assign variant_image = variant.image | img_url: 'large' %}
          {% else %}
            {% assign variant_image = 'no-image' %}
          {% endif %}
          {% unless variant.available %}
            <option value="{{ variant.id }}"
            data-id="{{ variant.id }}"
            data-variant-id="{{ variant.id }}" 
            data-price="{{ variant.price | money_with_currency | strip_html }}"
            data-compare-price="{{ variant.compare_at_price | money_with_currency | strip_html }}"
            data-inventory-quantity="0"
            data-image="{{ variant_image }}"
            data-disable-add-to-cart="true"
            data-product-title="{{product.title}}"
            data-variant-title="{{variant.title}}"
            data-product-id="{{product.id}}"
            data-estimated-ship-date="{{ product.metafields.suave['estimated_ship_date'] }}">
              {{ variant.title }} - Notify me when back in stock
            </option>
          {% endunless %}
        {% endfor %}
      </select>
      {% endunless %}
    </div>
    <div class="input-field col s4">
      {% if product.available %}
      <select 
        class="product-option quantity-selector" 
        aria-label="Quantity To Purchase" 
        {%- if is_bogo -%} data-is-bogo="true"{%- endif -%}>
        {% if product.selected_or_first_available_variant.inventory_policy == 'continue' %}
          {% assign x = 30 %}
        {% elsif product.selected_or_first_available_variant.inventory_quantity < 30 %}
          {% assign x = product.selected_or_first_available_variant.inventory_quantity %}
        {% else %}
          {% assign x = 30 %}
        {% endif %}
        {% if product.metafields.suave.max_purchase_quantity %}
          {% assign x = product.metafields.suave.max_purchase_quantity %}
        {% endif %}
        {% for i in (1..x) %}
          {%- if is_bogo -%}
            {%- assign modulos = i | modulo: 2 -%}
            {%- if modulos == 0 -%}
              <option value="{{i}}">{{i}}</option>
            {%- endif -%}
          {%- else -%}
            <option value="{{i}}">{{i}}</option>
          {%- endif -%}
        {% endfor %}
      </select>
      {% endif %}
    </div>
    <div class="col s12">
      {% if product.available %}
      <button class="btn waves-effect waves-light w100 add-to-cart background-s-red" type="submit" name="add">{{ button_text }}</button>
      {% else %}
      {% unless product.variants.size > 1 and product.available == false %}
      <button class="waves-effect waves-teal btn-flat w100" disabled="true">SOLD OUT</button>
      {% endunless %}
      <a href="#BisModal" class="btn-flat waves-effect waves-light w100 modal-trigger bis-modal-trigger color-s-red center-align" data-variant-id="{{product.selected_or_first_available_variant.id}}" data-product-title="{{product.title}}" data-variant-title="{{variant.title}}" data-product-id="{{product.id}}">NOTIFY WHEN BACK IN STOCK</a>
      {% endif %}
    </div>
  </div>
</form>